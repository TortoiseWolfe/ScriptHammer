# Implementation Plan: Template Fork Experience

**Branch**: `011-feature-038-template` | **Date**: 2025-12-10 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/011-feature-038-template/spec.md`

## Summary

Improve the ScriptHammer template forking experience based on real-world feedback from the SpokeToWork fork. Primary deliverable is a `scripts/rebrand.sh` script that automates 200+ file updates, reducing fork setup time from 2 hours to under 5 minutes. Secondary improvements include comprehensive Supabase mocking for tests, GitHub Pages deployment fixes, and graceful degradation UI.

## Technical Context

**Language/Version**: Bash 5.x (rebrand script), TypeScript 5.x (app changes)
**Primary Dependencies**: sed, find, grep (Unix tools), Vitest (testing)
**Storage**: N/A (no database changes)
**Testing**: Vitest unit tests, manual fork verification
**Target Platform**: Linux/macOS (Docker), GitHub Pages (deployment)
**Project Type**: Web application (Next.js 15 static export)
**Performance Goals**: Fork setup < 5 minutes
**Constraints**: Docker-first development, static export only
**Scale/Scope**: 200+ files to update, 13 issues to address

## Constitution Check

_GATE: Passed_

| Principle                    | Status  | Notes                                        |
| ---------------------------- | ------- | -------------------------------------------- |
| I. Component Structure       | ✅ Pass | SetupBanner component follows 5-file pattern |
| II. Test-First Development   | ✅ Pass | Supabase mock enables test-first             |
| III. PRP Methodology         | ✅ Pass | Following SpecKit workflow                   |
| IV. Docker-First Development | ✅ Pass | All commands via Docker                      |
| V. Progressive Enhancement   | ✅ Pass | Graceful degradation banner                  |
| VI. Privacy & Compliance     | ✅ N/A  | No user data involved                        |

## Project Structure

### Documentation (this feature)

```
specs/011-feature-038-template/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # Phase 0 research findings
├── data-model.md        # Configuration entities
├── quickstart.md        # Fork workflow guide
├── contracts/
│   ├── rebrand-script.md    # Script interface contract
│   └── supabase-mock.md     # Mock interface contract
└── tasks.md             # Generated by /tasks command
```

### Source Code Changes

```
scripts/
└── rebrand.sh               # NEW: Main rebrand automation script

tests/
└── setup.ts                 # MODIFY: Add Supabase client mock

src/
├── components/
│   ├── Footer.tsx           # MODIFY: Add template attribution link
│   └── SetupBanner/         # NEW: Graceful degradation banner
│       ├── index.tsx
│       ├── SetupBanner.tsx
│       ├── SetupBanner.test.tsx
│       ├── SetupBanner.stories.tsx
│       └── SetupBanner.accessibility.test.tsx
├── config/
│   └── project.config.test.ts  # MODIFY: Generic assertions
└── lib/
    └── supabase/
        └── client.ts        # MODIFY: Handle missing env gracefully

public/
├── sw.js                    # MODIFY: Dynamic cache names
└── manifest.json            # MOVE to .gitignore (generated)

docker-compose.yml              # MODIFY: Add GIT_AUTHOR env vars (root level)

.github/workflows/
└── deploy.yml               # MODIFY: Remove NEXT_PUBLIC_BASE_PATH line

next.config.ts               # MODIFY: Treat empty basePath as undefined
.env.example                 # MODIFY: Document GIT_AUTHOR vars
.gitignore                   # MODIFY: Add manifest.json
README.md                    # MODIFY: Add "Forking This Template" section
CLAUDE.md                    # MODIFY: Document Supabase secrets requirement
```

**Structure Decision**: Single web application, no new directories except SetupBanner component (following 5-file pattern).

## Implementation Phases

### Phase 1: Rebrand Script (P1 - Critical)

**Goal**: Create `scripts/rebrand.sh` that automates template rebranding

**Tasks**:

1. Create script skeleton with argument parsing
2. Implement name sanitization (spaces→hyphens, remove special chars)
3. Implement content replacement (sed across file types)
4. Implement file renaming (find + mv)
5. Implement docker-compose service name update
6. Implement CNAME deletion
7. Implement git remote URL update
8. Add previous-rebrand detection with user prompt
9. Add verbose output per file
10. Add --dry-run and --force flags
11. Test with actual fork

**Files**: `scripts/rebrand.sh` (new)

### Phase 2: Test Infrastructure (P2 - High)

**Goal**: Tests pass without Supabase environment variables

**Tasks**:

1. Add comprehensive Supabase client mock to tests/setup.ts
2. Mock auth methods (getSession, getUser, signIn, signUp, signOut, onAuthStateChange)
3. Mock database methods (from, select, insert, update, delete)
4. Mock realtime methods (channel, on, subscribe)
5. Mock storage methods (upload, getPublicUrl, remove)
6. Update project.config tests to use generic assertions
7. Verify all tests pass with no .env file

**Files**: `tests/setup.ts`, `src/config/__tests__/project.config.test.ts`

### Phase 3: GitHub Pages Fix (P3 - High)

**Goal**: Forks deploy correctly without NEXT_PUBLIC_BASE_PATH secret

**Tasks**:

1. Remove NEXT_PUBLIC_BASE_PATH line from deploy.yml
2. Update next.config.ts to treat empty string as undefined
3. Verify auto-detection works in GitHub Actions
4. Test with actual fork deployment

**Files**: `.github/workflows/deploy.yml`, `next.config.ts`

### Phase 4: Docker Git Workflow (P4 - Medium)

**Goal**: Git commits work from Docker container

**Tasks**:

1. Verify git safe.directory already in Dockerfile (confirmed)
2. Add GIT_AUTHOR_NAME and GIT_AUTHOR_EMAIL to docker-compose.yml
3. Document GIT_AUTHOR vars in .env.example
4. Update CLAUDE.md with container commit instructions

**Files**: `docker-compose.yml`, `.env.example`, `CLAUDE.md`

### Phase 5: Graceful Degradation (P5 - Medium)

**Goal**: App shows setup banner when Supabase not configured

**Tasks**:

1. Create SetupBanner component (5-file pattern)
2. Implement dismissible banner with session storage
3. Modify Supabase client to not throw on missing env
4. Add banner to app layout when Supabase unavailable
5. Style with DaisyUI alert component

**Files**: `src/components/SetupBanner/*`, `src/lib/supabase/client.ts`, `src/app/layout.tsx`

### Phase 6: Dynamic Configuration (P6 - Low)

**Goal**: Service worker and manifest use dynamic project name

**Tasks**:

1. Update sw.js to read cache name from config
2. Add manifest.json to .gitignore
3. Verify generate-manifest.js creates correct file
4. Update ADMIN_EMAIL to use env var with fallback

**Files**: `public/sw.js`, `.gitignore`, `scripts/generate-manifest.js`

### Phase 7: Documentation (P7 - Low)

**Goal**: Comprehensive fork documentation

**Tasks**:

1. Add "Forking This Template" section to README
2. Document Supabase GitHub secrets in CLAUDE.md
3. Add template attribution link to Footer
4. Create docs/FORKING.md with detailed guide

**Files**: `README.md`, `CLAUDE.md`, `src/components/Footer.tsx`, `docs/FORKING.md`

### Phase 8: Polish & Verification (P8 - Final)

**Goal**: Final verification and cleanup

**Tasks**:

1. Run full test suite (pnpm test)
2. Run build (pnpm run build)
3. Run lint and type-check
4. Test rebrand script edge cases (special chars, idempotency, case-sensitivity)
5. Verify quickstart.md workflow end-to-end
6. Update Progress Tracking

**Files**: All previously modified files (verification only)

## Risk Mitigation

| Risk                 | Impact | Mitigation                             |
| -------------------- | ------ | -------------------------------------- |
| Rebrand misses files | High   | grep verification step, test with fork |
| Tests still fail     | High   | Run full test suite in CI without env  |
| Deploy breaks        | High   | Test with actual fork before merge     |
| Script not portable  | Medium | Use POSIX-compliant shell commands     |

## Success Verification

- [ ] `./scripts/rebrand.sh TestApp testuser "Test"` completes without errors
- [ ] `grep -r "ScriptHammer"` returns 0 matches after rebrand
- [ ] `pnpm test` passes with no .env file
- [ ] `pnpm run build` succeeds after rebrand
- [ ] Fork deploys to GitHub Pages without basePath secret
- [ ] Setup banner appears when Supabase not configured
- [ ] All 793+ existing tests still pass

## Progress Tracking

| Phase             | Status      | Artifacts                                |
| ----------------- | ----------- | ---------------------------------------- |
| Phase 0: Research | ✅ Complete | research.md                              |
| Phase 1: Design   | ✅ Complete | data-model.md, contracts/, quickstart.md |
| Phase 2: Tasks    | ⏳ Pending  | tasks.md (via /tasks command)            |
| Implementation    | ⏳ Pending  | Code changes                             |
| Verification      | ⏳ Pending  | Test results                             |
